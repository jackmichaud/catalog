{% load static %}

<!DOCTYPE html>
<html>

<head>
    <link rel="icon" href="{% static 'home/favicon.ico' %}" type="image/x-icon">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CataLog{% endblock %}</title>

    <!-- Global Styles -->
    <link rel="stylesheet" href="{% static 'home/style.css' %}">
    <link rel="stylesheet" href="{% static 'home/csp-inline-fixes.css' %}">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet">

    <!-- Mapbox JS (available globally) -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js" nonce="{{ request.csp_nonce }}"></script>

    {% block extra_head %}{% endblock %}
</head>

<body>
    <!-- Shared Navbar -->
    <nav>
        <h2><a href="{% url 'index' %}" class="csp-b784ff6068">CataLog</a></h2>
        <ul>
            <li><a href="{% url 'index' %}">Home</a></li>
            <li><a href="{% url 'about' %}">About</a></li>
            <li><a href="{% url 'learn' %}">Learn More</a></li>
            <li><a href="{% url 'community' %}">Community</a></li>
            {% if user.role == 'moderator' %}
            <li><a href="{% url 'moderator' %}">Moderation</a></li>
            {% endif %}
            {% if user.is_authenticated %}
            <li><a href="{% url 'conversation_list' %}" class="csp-4bfe6d5aff">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <line x1="8" y1="9" x2="16" y2="9"></line>
                    <line x1="8" y1="13" x2="16" y2="13"></line>
                </svg>
                {% if unread_message_count > 0 %}
                <span class="badge csp-724c3bf4fa" >{{unread_message_count }}</span>
                {% endif %}
            </a></li>
            <li class="notifications-dropdown">
                <a href="#" id="notifications-toggle" class="csp-4bfe6d5aff">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    {% if unread_notification_count > 0 %}
                    <span class="badge csp-724c3bf4fa" >{{unread_notification_count }}</span>
                    {% endif %}
                </a>
                <div class="notifications-dropdown-menu" id="notifications-dropdown">
                    <div class="notifications-dropdown-header">
                        <h3>Notifications</h3>
                        <div class="notification-header-actions">
                            <div class="notifications-menu-container">
                                <button id="notifications-menu-btn" class="notifications-menu-btn" title="More options">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="1"></circle>
                                        <circle cx="12" cy="5" r="1"></circle>
                                        <circle cx="12" cy="19" r="1"></circle>
                                    </svg>
                                </button>
                                <div class="notifications-submenu" id="notifications-submenu">
                                    <a href="#" id="mark-all-read-menu" class="submenu-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        Mark all as read
                                    </a>
                                    <a href="/notifications/" class="submenu-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <line x1="9" y1="9" x2="15" y2="9"></line>
                                            <line x1="9" y1="15" x2="15" y2="15"></line>
                                        </svg>
                                        Open Notifications
                                    </a>
                                </div>
                            </div>
                            <button id="delete-selected-dropdown-btn" class="delete-all-btn csp-5790ffba29"  title="Delete Selected">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="notifications-actions-bar csp-5790ffba29" id="notifications-actions-bar" >
                        <button id="mark-selected-read-btn" class="action-bar-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Mark as read
                        </button>
                    </div>
                    <div class="notifications-dropdown-list" id="notifications-list">
                        <div class="loading-notifications">Loading...</div>
                    </div>
                </div>
            </li>
            <li class="profile-dropdown">
                <a href="#" class="profile-toggle csp-ca8dfae588" >
                    {% if user.avatar and user.avatar.public_url %}
                    <img src="{{ user.avatar.public_url }}" alt="{{ user.get_display_name }}" class="csp-85c3f16ccb">
                    {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="white" class="csp-b65019ab18">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    {% endif %}
                </a>
                <div class="dropdown-menu">
                    <a href="{% url 'profile' %}">Your Profile</a>
                    <a href="{% url 'account_settings' %}">Account Settings</a>
                    <a href="{% url 'account_logout' %}">Logout</a>
                </div>
            </li>
            {% else %}
                <li><a href="/accounts/login/">Login</a></li>
            {% endif %}
        </ul>
    </nav>

    <!-- Page-specific content -->
    {% block content %}{% endblock %}

    <!-- Optional per-page scripts -->
    {% block scripts %}{% endblock %}

    <!-- Profile Dropdown Script -->
    <script nonce="{{ request.csp_nonce }}">
        document.addEventListener('DOMContentLoaded', function () {
            const profileDropdown = document.querySelector('.profile-dropdown');
            const profileToggle = document.querySelector('.profile-toggle');

            if (profileToggle) {
                profileToggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    profileDropdown.classList.toggle('active');
                    // Close notifications dropdown if open
                    const notificationsDropdown = document.querySelector('.notifications-dropdown');
                    if (notificationsDropdown) {
                        notificationsDropdown.classList.remove('active');
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function (e) {
                    if (!profileDropdown.contains(e.target)) {
                        profileDropdown.classList.remove('active');
                    }
                });
            }

            // Load saved theme on all pages
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            // Notifications Dropdown
            const notificationsToggle = document.getElementById('notifications-toggle');
            const notificationsDropdown = document.querySelector('.notifications-dropdown');
            const notificationsList = document.getElementById('notifications-list');

            if (notificationsToggle) {
                notificationsToggle.addEventListener('click', async function (e) {
                    e.preventDefault();
                    notificationsDropdown.classList.toggle('active');
                    // Close profile dropdown if open
                    if (profileDropdown) {
                        profileDropdown.classList.remove('active');
                    }

                    // Load notifications when dropdown opens
                    if (notificationsDropdown.classList.contains('active')) {
                        await loadNotifications();
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function (e) {
                    if (!notificationsDropdown.contains(e.target)) {
                        notificationsDropdown.classList.remove('active');
                    }
                });
            }

            // Three-dot menu toggle
            const notificationsMenuBtn = document.getElementById('notifications-menu-btn');
            const notificationsSubmenu = document.getElementById('notifications-submenu');

            if (notificationsMenuBtn) {
                notificationsMenuBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    notificationsSubmenu.classList.toggle('active');
                });

                // Close submenu when clicking outside
                document.addEventListener('click', function (e) {
                    if (!notificationsSubmenu.contains(e.target) && e.target !== notificationsMenuBtn) {
                        notificationsSubmenu.classList.remove('active');
                    }
                });
            }

            // Mark selected as read button (outside three-dot menu)
            const markSelectedReadBtn = document.getElementById('mark-selected-read-btn');
            if (markSelectedReadBtn) {
                markSelectedReadBtn.addEventListener('click', async function (e) {
                    e.stopPropagation();

                    const checkboxes = document.querySelectorAll('.notification-checkbox-dropdown:checked');
                    const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

                    if (selectedIds.length === 0) {
                        return;
                    }

                    try {
                        // Mark each selected notification as read
                        for (const notificationId of selectedIds) {
                            await fetch(`/api/notifications/${notificationId}/read/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': getCookie('csrftoken')
                                }
                            });
                        }
                        location.reload();
                    } catch (error) {
                        console.error('Error marking notifications as read:', error);
                    }
                });
            }

            // Mark all as read from menu
            const markAllMenuBtn = document.getElementById('mark-all-read-menu');
            if (markAllMenuBtn) {
                markAllMenuBtn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        const response = await fetch('/api/notifications/mark-all-read/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });

                        if (response.ok) {
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Error marking all notifications as read:', error);
                    }
                });
            }

            // Delete selected button
            const deleteSelectedBtn = document.getElementById('delete-selected-dropdown-btn');
            if (deleteSelectedBtn) {
                deleteSelectedBtn.addEventListener('click', async function (e) {
                    e.stopPropagation();
                    const checkboxes = document.querySelectorAll('.notification-checkbox-dropdown:checked');
                    const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

                    if (selectedIds.length === 0) {
                        return;
                    }

                    if (!confirm(`Delete ${selectedIds.length} notification(s)?`)) {
                        return;
                    }

                    try {
                        const response = await fetch('/api/notifications/delete/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                notification_ids: selectedIds
                            })
                        });

                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('Error deleting notifications');
                        }
                    } catch (error) {
                        console.error('Error deleting notifications:', error);
                        alert('Error deleting notifications');
                    }
                });
            }

            async function loadNotifications() {
                try {
                    const response = await fetch('/api/notifications/');
                    const data = await response.json();

                    if (data.notifications && data.notifications.length > 0) {
                        notificationsList.innerHTML = data.notifications.map(notification => `
                            <div class="notification-dropdown-item ${!notification.is_read ? 'unread' : ''}" data-notification-id="${notification.id}">
                                <div class="notification-icon-dropdown">
                                    ${notification.notification_type === 'tree_flagged' ? '⚠️' :
                                      notification.notification_type === 'tree_unflagged' ? '✅' : '❌'}
                                </div>
                                <div class="notification-content-dropdown">
                                    <div class="notification-message-dropdown">${notification.message}</div>
                                    <div class="notification-time-dropdown">${notification.created_at}</div>
                                </div>
                                ${!notification.is_read ? '<div class="unread-dot"></div>' : ''}
                            </div>
                        `).join('');
                    } else {
                        notificationsList.innerHTML = '<div class="no-notifications-dropdown">No notifications</div>';
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                    notificationsList.innerHTML = '<div class="no-notifications-dropdown">Error loading notifications</div>';
                }
            }

            function toggleDeleteButton() {
                const checkboxes = document.querySelectorAll('.notification-checkbox-dropdown');
                const deleteBtn = document.getElementById('delete-selected-dropdown-btn');
                const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
                if (deleteBtn) {
                    deleteBtn.style.display = anyChecked ? 'inline-flex' : 'none';
                }
            }
        });


        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>

</html>